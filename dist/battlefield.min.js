!function(e){"use strict";function t(e){if(o instanceof t)return o;o=this;var r=this;if("object"==typeof e){for(var i in u)f[i]=e.hasOwnProperty(i)?e[i]:u[i];f=Object.assign(f,h)}else f=Object.assign(u,h);this.totals=[],f.fName.forEach(function(e,t){if(t<2){var i=0==t?"kUser":"kEnemy";f.player[i]=e,r.totals[e]=0}})}function r(e){if(!e.fName instanceof Array||0===e.fName.length)throw new Error(d.getMessage("error_field_name"));if("object"!=typeof e.fSize||"number"!=typeof e.fSize.h||"number"!=typeof e.fSize.v)throw new TypeError(d.getMessage("error_field_size"));if(!e.fBarrier instanceof Array)throw new TypeError(d.getMessage("error_barrier_type"));if("object"!=typeof e.tPoint)throw new Error(d.getMessage("error_point_type"));this.fName=e.fName,this.fSize=e.fSize,this.fBarrier=e.fBarrier,this.tPoint=e.tPoint,this.fList={}}function i(e,t){function r(){for(var e=[],t=0;t<f.fSize.h;t++)for(var r=0;r<f.fSize.v;r++)e.push([r,t]);return e}function i(){var e=0;return f.fBarrier.forEach(function(t){e+=t[0]*t[1]}),e}if(!t instanceof n)throw new Error(d.getMessage("error_ui_instance"));this.ui=t,this.fields=e,this._lsKill=[],this._lsShot=[],this._ctnCell=[];for(var o in f.player){var a=f.player[o];this._lsKill[a]=[],this._lsShot[a]=r(),this._ctnCell[a]=i()}this.userKey=f.player.kUser,this.enemyKey=f.player.kEnemy,this.player=d.rand(1,2)%2?this.userKey:this.enemyKey,this.game(this.player)}function n(e){try{this.containerField=document.querySelector(f.containerField),this.containerLog=document.querySelector(f.containerLog),this.containerStatus=document.querySelector(f.containerStatus),this.posLeft=!0,this.battlefild=e,this.defaultHTML()}catch(e){this.exceptionInfo(e)}}var o={},a=!1,s=!1,l=!1,c=!1,f={},u={containerField:".game-field",containerLog:".game-log",containerStatus:".gamer-data",fSize:{h:15,v:15},fBarrier:[[5,1],[4,2],[3,3],[2,4],[1,5]],marker:{h:"string",v:"number"},helpPoint:!0,timeoutAI:400,timeoutBrain:5e3},h={fName:["FUser","FBrain"],player:{kUser:"",kEnemy:""},tPoint:{DEF:0,BAR:1,KIL:2,NUL:3}};t.prototype.brainBrain=function(e){return a=e||!1,a?(d.__userName="Компьютер.Левый",d.__brainName="Компьютер.Правый"):(d.__userName=d.__userNameDef,d.__brainName=d.__brainNameDef),this},t.prototype.recursive=function(e){return s=e||!1,this.brainBrain(!0),this},t.prototype.run=function(){function e(){c=!0;var e=document.querySelector("ul.menu"),t=[],r=[{name:"Настройки",onClick:function(e){console.log("Настройки")}}];r.forEach(function(r,i){t[i]=document.createElement("a"),t[i].innerHTML=r.name,t[i].setAttribute("href","javascript:void(0);"),"function"==typeof r.onClick&&(t[i].onclick=function(e){r.onClick()});var n=document.createElement("li");n.appendChild(t[i]),e.appendChild(n)})}var t=new n(this);try{document.querySelector(f.containerField).innerHTML="",c||e();var o=new r({fName:f.fName,fSize:f.fSize,fBarrier:f.fBarrier,tPoint:f.tPoint}),a=o.createField().setBarrier(function(e,r){t.createFieldHTML(e,r)});new i(a,t,f)}catch(e){t.exceptionInfo(e)}},t.prototype.setLevel=function(e){var t={easy:{fSize:{h:10,v:10},fBarrier:[[4,1],[3,2],[2,3],[1,4]]},middle:{fSize:{h:15,v:15},fBarrier:[[5,1],[4,2],[3,3],[2,4],[1,5]]},hard:{fSize:{h:15,v:20},fBarrier:[[6,1],[5,2],[4,3],[3,4],[2,5],[1,6]]},dev:{fSize:{h:20,v:20},fBarrier:[[1,6]]}};if("object"==typeof t[e]){var r=t[e];return f.fSize=r.fSize,f.fBarrier=r.fBarrier,this}throw new Error("Указан несуществующий уровень сложности")},t.prototype.setPlayerName=function(e){return"string"==typeof e&&e.length>=3&&(d.__userName=e,d.__userNameDef=e),this},r.prototype.createField=function(){var e=this;return e.fName.forEach(function(t){for(var r=new Array(e.fSize.v),i=0;i<e.fSize.v;i++){r[i]=new Array(e.fSize.h);for(var n=0;n<e.fSize.h;n++)r[i][n]=e.tPoint.DEF}e.fList[t]=r}),this},r.prototype.setBarrier=function(e){function t(e,o){if(!(n>0))throw new Error(d.getMessage("error_max_iterations"));n--;for(var a=[],s=d.rand(0,i.fSize.v-1),l=d.rand(0,i.fSize.h-1),c=!!(d.rand(1,2)%2),f=0;f<e;f++){var u=s,h=l;if(c?u=s+f:h=l+f,!r(u,h,o))return t(e,o);a.push([u,h])}return a.forEach(function(e){var t=e[0],r=e[1];o[t][r]=i.tPoint.BAR}),o}function r(e,t,r){var n=[[-1,0],[-1,-1],[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1]],o=0,a=0,s=i.fSize.v-1,l=i.fSize.h-1;if(e<0||e>s||t<0||t>l)return!1;if(r[e][t]!==i.tPoint.DEF)return!1;for(var c=0;c<n.length;c++)if(o=e+n[c][0],a=t+n[c][1],o>=0&&o<=s&&a>=0&&a<=l&&r[o][a]!=i.tPoint.DEF)return!1;return!0}var i=this,n=100*i.fName.length;return i.fName.forEach(function(r){var n=i.fList[r];i.fBarrier.forEach(function(e){for(var r=e[0],i=e[1],o=0;o<i;o++)n=t(r,n)}),i.fList[r]=n,"function"==typeof e&&e(n,r)}),i.fList},i.prototype.game=function(e){try{switch(this.ui.showProgress(e),this.player=e,e){case this.userKey:a?this.AIShot(this.enemyKey):this.userShot();break;case this.enemyKey:this.AIShot(this.userKey);break;default:throw new Error(d.getMessage("error_game_not_found"))}}catch(e){this.ui.exceptionInfo(e)}},i.prototype.userShot=function(){var e=this;this.ui.clickToField(this.enemyKey,function(t){if(e.player!==e.userKey)return!1;try{var r=e.enemyKey,i=t.target.parentNode.cellIndex,n=t.target.parentNode.parentNode.rowIndex;e.shot([n,i],r)}catch(t){e.game(e.userKey)}})},i.prototype.AIShot=function(e){function t(){var s=[];if(a._lsKill[e].length>0)s=r();else{var l=d.rand(0,a._lsShot[e].length-1);s=a._lsShot[e][l],a._lsShot[e].splice(l,1)}if(s instanceof Array&&"undefined"!==s[0]&&"undefined"!==s[1]){var c=s[0],f=s[1];if(c>=0&&c<i.v&&f>=0&&f<i.h&&(o[c][f]!==n.NUL||o[c][f]!==n.BAR))return s}return t()}function r(){var t=[[-1,0],[0,-1],[1,0],[0,1]],r=a._lsKill[e],s=[];if(1==r.length){var l=r[0][0],c=r[0][1];t=d.shuffle(t);for(var f=0;f<t.length;f++){var u=l+t[f][0],h=c+t[f][1];if(u>=0&&u<i.v&&h>=0&&h<i.h&&o[u][h]!==n.NUL)return[u,h]}}else{for(var p=r[0][0]==r[1][0],m=i.h+i.v,v=0,f=0;f<r.length;f++){var y=p?r[f][1]:r[f][0];m=m>y?y:m,v=v<y?y:v}var g=d.rand(1,2)%2?m-1:v+1;s=p?[r[0][0],g]:[g,r[0][1]]}return s}var i=f.fSize,n=f.tPoint,o=this.fields[e],a=this,s=t();setTimeout(function(){a.shot(s,e)},f.timeoutAI)},i.prototype.shot=function(e,t){function r(e,t){var r=e[0],i=e[1];switch(s.fields[t][r][i]){case a.DEF:return!1;case a.BAR:return!0;default:return null}}function i(e,t){function r(e,t){var s=e[0],c=e[1],f=!1,u=!1,h=[];"object"==typeof t&&(f=t[0],u=t[1]);for(var d=0;d<i.length;d++){var p=s+i[d][0],m=c+i[d][1];if(p==f&&m==u);else if(p>=0&&p<o.v&&m>=0&&m<o.h){var v=n[p][m];if(v==a.BAR)return!1;v==a.KIL?h.push([[p,m],[s,c]]):l.push([p,m])}}if(0===h.length)return!0;for(var y=0,g=0;g<h.length;g++){if(!r(h[g][0],h[g][1]))return!1;y++}return y==h.length}var i=[[-1,0],[-1,-1],[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1]],n=s.fields[t],l=[];return!!r(e)&&l}function n(e){return 0===s._ctnCell[e]}var o=f.fSize,a=f.tPoint,s=this,l=t==this.userKey?this.enemyKey:this.userKey,c=e[0],u=e[1],h=r(e,t);if("boolean"==typeof h)if(h){this._ctnCell[t]--,this.fields[t][c][u]=a.KIL,this.ui.setMarker(e,a.KIL,t);var d=i(e,t);"boolean"==typeof d?(this._lsKill[t].push(e),this.ui.printLog(e,a.KIL,t),this.ui.setHelpMarker(e,t,function(e,t){var r=e[0],i=e[1];f.helpPoint&&s.ui.setMarker(e,a.NUL,t,!0),s.fields[t][r][i]=a.NUL})):(this._lsKill[t]=[],this.ui.printLog(e,a.KIL+"_death",t),d.forEach(function(e){var r=e[0],i=e[1];f.helpPoint&&s.ui.setMarker(e,a.NUL,t,!0),s.fields[t][r][i]=a.NUL})),n(t)?this.ui.finalGame(l,t):this.game(l)}else this.fields[t][c][u]=a.NUL,this.ui.setMarker(e,a.NUL,t),this.ui.printLog(e,a.NUL,t),this.game(t);else this.game(l)},n.prototype.defaultHTML=function(){if("object"==typeof this.containerStatus){var e=f.player.kUser,t=f.player.kEnemy,r='<span class="name '+e+'">'+d.getMessage("player_"+e)+'</span><span class="total '+e+'">'+parseInt(this.battlefild.totals[e])+'</span><span>&amp;</span><span class="total '+t+'">'+this.battlefild.totals[t]+'</span><span class="name '+t+'">'+d.getMessage("player_"+t)+"</span>";this.containerStatus.innerHTML=r}"object"==typeof this.containerLog&&this.containerLog.appendChild(document.createElement("ul"))},n.prototype.createFieldHTML=function(e,t){function r(e,t,r){if(!e instanceof Array)throw new Error(d.getMessage("error_field_invalid"));var i=r||!1,n="";n+='<table class="field '+t+'">';for(var o=0;o<e.length;o++){n+="<tr>";for(var a=0;a<e[o].length;a++){var s="",l="";if(f.marker!==!1&&"object"==typeof f.marker){var c="undefined"!=typeof f.marker.v&&"string"==f.marker.v?d.getLetter(a):a+1,u="undefined"!=typeof f.marker.h&&"string"==f.marker.h?d.getLetter(o):o+1;s=0===o?'<div class="mm">'+c+"</div>":"",l=0===a?'<div class="ll">'+u+"</div>":""}var h=i&&e[o][a]==f.tPoint.BAR?" let":"";n+="<td>"+s+l+'<div class="box'+h+'"></div></td>'}n+="</tr>"}return n+="</table>"}function i(){var e="";return f.fBarrier.forEach(function(t){for(var r="",i=0;i<t[0];i++)r+='<div class="box"></div>';e+='<div class="let"><span>x'+t[1]+"</span>"+r+"</div>"}),'<div class="list-let">'+e+"</div>"}var n=document.createElement("div"),o=!!this.posLeft||a,s=this.posLeft?"lf":"rg",l=r(e,t,o),c=i();n.setAttribute("class","board "+s),n.innerHTML=l+c,this.containerField.appendChild(n),this.posLeft=!this.posLeft},n.prototype.showProgress=function(e){this.containerStatus.querySelectorAll(".name").forEach(function(e){e.classList.remove("act")}),this.containerStatus.querySelector(".name."+e).classList.add("act")},n.prototype.clickToField=function(e,t){this.containerField.querySelector("table.field."+e).onclick=t},n.prototype.setMarker=function(e,t,r,i){var i=i||!1,n=e[0],o=e[1],a="";switch(t){case f.tPoint.KIL:a="kill";break;case f.tPoint.KIL+"_death":a="kill";break;case f.tPoint.NUL:a=i?"auto-null":"null"}var s=this.containerField.querySelector("table.field."+r).rows[n].cells[o].querySelector(".box");s.className+=" "+a},n.prototype.setHelpMarker=function(e,t,r){for(var i=e[0],n=e[1],o=[[-1,-1],[1,-1],[1,1],[-1,1]],a=0;a<o.length;a++){var s=i+o[a][0],l=n+o[a][1];s>=0&&s<f.fSize.v&&l>=0&&l<f.fSize.h&&"function"==typeof r&&r([s,l],t)}},n.prototype.printLog=function(e,t,r){var i=e[0],n=e[1],o="",a="";switch(t){case f.tPoint.KIL:o="war",a="ранил";break;case f.tPoint.KIL+"_death":o="kil",a="убил";break;case f.tPoint.NUL:o="nul",a="мимо"}var s=r==f.player.kUser?d.getMessage("player_"+f.player.kEnemy):d.getMessage("player_"+f.player.kUser),l=new Date,c=l.toLocaleTimeString(),u="";u+="string"==f.marker.h?d.getLetter(i):i+1,u+="x",u+="string"==f.marker.v?d.getLetter(n):n+1;var h='<span class="point">'+u+'</span><span class="type '+o+'">'+a+'</span><span class="name">'+s+'</span><span class="time">'+c+"</span>",p=document.createElement("li");p.innerHTML=h,this.containerLog.querySelector("ul").insertBefore(p,this.containerLog.querySelector("ul").firstChild)},n.prototype.finalGame=function(e,t){var r=this,i="";if(++this.battlefild.totals[e],s){i="Новый раунд начнется через <b>"+f.timeoutBrain/1e3+"</b> сек.";var n=this.modalWindow("Конец раунда",i,[{value:"Играть самому",className:"green",onClick:function(e,t){clearTimeout(timerId);for(var i in r.battlefild.totals)r.battlefild.totals[i]=0;f=u,f=Object.assign(f,h),r.battlefild.recursive(!1).brainBrain(!1).run(),t.close()}},{value:"Остановить",className:"red",onClick:function(e,t){clearTimeout(l),t.close()}}]);return void(l=setTimeout(function(){r.battlefild.run(),n.close()},f.timeoutBrain))}i+='<div class="final">',i+='<table>   <tr class="winner">       <td><b>Победитель</b></td>       <td>'+d.getMessage("player_"+e)+'</td>   </tr>   <tr class="loser">       <td><b>Проиграл</b></td>       <td>'+d.getMessage("player_"+t)+"</td>   </tr></table>",i+="</div>",this.modalWindow("Конец игры",i,[{value:"Новая игра",className:"green",onClick:function(e,t){r.battlefild.run(),t.close()}},{value:"Закрыть",className:"red",onClick:function(e,t){t.close()}}])},n.prototype.modalWindow=function(e,t,r){var i={_fontID:"modal_font",_contID:"modal_cont",modBox:!1,closeBtn:!1,box:!1,foot:!1,constructModal:function(){if(this.createHTML(),this.modBox=document.querySelector(".modal-box#"+this._contID),this.closeBtn=this.modBox.querySelector(".modal-close"),this.box=this.modBox.querySelector(".box"),this.foot=this.modBox.querySelector(".mod_foot"),this.box.innerHTML=t,r instanceof Array&&r.length>0){var e=this,i=[];r.forEach(function(t,r){var n="string"==typeof t.className?t.className:"";i[r]=document.createElement("button"),i[r].setAttribute("class","btn "+n),i[r].innerHTML=t.value,"function"==typeof t.onClick&&(i[r].onclick=function(r){t.onClick(r,e)}),e.foot.appendChild(i[r])})}else this.foot.style.display="none";this.autoPosition();var e=this;this.closeBtn.onclick=function(){e.close()}},createHTML:function(){var t=document.createElement("div");t.setAttribute("class","modal-font"),t.setAttribute("id",this._fontID);var r=document.createElement("div");r.setAttribute("class","modal-box"),r.setAttribute("id",this._contID),r.innerHTML='<div class="modal-close">&#215;</div><div class="mod_head">'+e+'</div><div class="box"></div><div class="mod_foot"></div>';var i=document.querySelector("body");i.appendChild(t),i.appendChild(r)},autoPosition:function(){var e=this.modBox.clientWidth/2,t=this.modBox.clientHeight/2;this.modBox.style.marginTop=t*-1+"px",this.modBox.style.marginLeft=e*-1+"px"},close:function(){var e=document.querySelector(".modal-font#"+this._fontID),t=document.querySelector(".modal-box#"+this._contID);null!==e&&document.body.removeChild(e),null!==t&&document.body.removeChild(t)}};return i.constructModal(),i},n.prototype.exceptionInfo=function(e){console.log(e);var t=this,r="",i="",n=[];switch(e.name){case"Error":r="Критическая ошибка",i="<b>"+e.message+'</b><span class="info">Невозможнно продолжить игру</span>',n=[{value:"Параметры по умолчанию",className:"green",onClick:function(e,r){f=u,f=Object.assign(f,h),t.battlefild.run(),r.close()}}];break;case"TypeError":r="Не верно указаны параметры",i="<b>"+e.message+'</b><span class="info">Измените настройки игры</span>';break;default:r="Ошибка типа: "+e.name,i="<b>"+e.message+"</b>"}this.modalWindow(r,i,n)};var d={__userName:"Игрок",__brainName:"Компьютер",__userNameDef:"Игрок",__brainNameDef:"Компьютер",rand:function(e,t){var e=e||0,t=t||100;return parseInt(Math.random()*(t-e+1)+e)},shuffle:function(e){for(var t,r,i=0;i<e.length-1;i++)t=this.rand(0,e.length-1),r=e[t],e[t]=e[e.length-1],e[e.length-1]=r;return e},getLetter:function(e,t){var t=t||"",r="ABCDEFGHIJKLMNOPQRSTUVWXYZ";return e>r.length?d.getLetter(e-r.length,""==t?1:t+1):r[e]+t},getMessage:function(e){var t={error_field_name:"Не верно указаны названия игровых полей",error_field_size:"Неверно установлен размер игрового поля",error_field_invalid:"Не могу напечатать игровое поле, неверный формат",error_barrier_type:"Неверно указан список кораблей",error_point_type:"Не установлены типы содержимого",error_max_iterations:"Чего то я залип в рекурсии, может стоит изменить параметры??",error_ui_instance:"Я не могу взаимодействовать с интерфейсом из за неправильно переданного параметра",error_game_not_found:"Ход не известного мне игрока",player_FUser:this.__userName,player_FBrain:this.__brainName};return"string"==typeof t[e]?t[e]:e}};e.Battlefield=t}(this);